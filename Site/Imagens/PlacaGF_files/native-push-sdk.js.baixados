/*! For license information please see native-push-sdk.js.LICENSE.txt */
!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function n(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?t(Object(i),!0).forEach(function(t){r(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):t(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function r(t,n,r){return(n=function(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}(n))in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}function i(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,i,o){var a=r&&r.prototype instanceof p?r:p,u=Object.create(a.prototype);return s(u,"_invoke",function(n,r,i){var s,o,a,p=0,u=i||[],d=!1,h={p:0,n:0,v:e,a:l,f:l.bind(e,4),d:function(t,n){return s=t,o=0,a=e,h.n=n,c}};function l(n,r){for(o=n,a=r,t=0;!d&&p&&!i&&t<u.length;t++){var i,s=u[t],l=h.p,g=s[2];n>3?(i=g===r)&&(a=s[(o=s[4])?5:(o=3,3)],s[4]=s[5]=e):s[0]<=l&&((i=n<2&&l<s[1])?(o=0,h.v=r,h.n=s[1]):l<g&&(i=n<3||s[0]>r||r>g)&&(s[4]=n,s[5]=r,h.n=g,o=0))}if(i||n>1)return c;throw d=!0,r}return function(i,u,g){if(p>1)throw TypeError("Generator is already running");for(d&&1===u&&l(u,g),o=u,a=g;(t=o<2?e:a)||!d;){s||(o?o<3?(o>1&&(h.n=-1),l(o,a)):h.n=a:h.v=a);try{if(p=2,s){if(o||(i="next"),t=s[i]){if(!(t=t.call(s,a)))throw TypeError("iterator result is not an object");if(!t.done)return t;a=t.value,o<2&&(o=0)}else 1===o&&(t=s.return)&&t.call(s),o<2&&(a=TypeError("The iterator does not provide a '"+i+"' method"),o=1);s=e}else if((t=(d=h.n<0)?a:n.call(r,h))!==c)break}catch(t){s=e,o=1,a=t}finally{p=1}}return{value:t,done:d}}}(n,i,o),!0),u}var c={};function p(){}function u(){}function d(){}t=Object.getPrototypeOf;var h=[][r]?t(t([][r]())):(s(t={},r,function(){return this}),t),l=d.prototype=p.prototype=Object.create(h);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=d,s(l,"constructor",d),s(d,"constructor",u),u.displayName="GeneratorFunction",s(d,o,"GeneratorFunction"),s(l),s(l,o,"Generator"),s(l,r,function(){return this}),s(l,"toString",function(){return"[object Generator]"}),(i=function(){return{w:a,m:g}})()}function s(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}s=function(e,t,n,r){function o(t,n){s(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(o("next",0),o("throw",1),o("return",2))},s(e,t,n,r)}function o(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function a(){this.partnerName=Insider.partner.name,this.localStorage="storageData",this.webPushStorageKey="ins-wp-storage",this.debug=!0,this.tokenCollectorUrl="https://carrier.useinsider.com/v2/web-push/token-collector",this.hitApiUrl="https://hit.api.useinsider.com/hit",this.swPath=Insider.webPushState.nativeOptInSDKCustomPath?Insider.webPushState.nativeOptInSDKCustomPath:"/insider-sw-sdk.js",this.VAPIDPublicKey=Insider.webPushState.VAPIDPublicKey,this.isVAPIDActive=!Insider.fns.isEmptyString(this.VAPIDPublicKey),this.wpLogUrl="https://wp-log.api.useinsider.com/v2/collect",this.STORAGE={PAYLOAD_COMPLETE:"ins-wp-payload-complete",TOKEN_CREATE_DATE:"ins-wp-token-create-date",MIGRATED_SDK:"ins-wp-migrated-sdk",TOKEN:"ins-wp-token",REQUEST_SENT:"ins-wp-request-sent",NATIVE_PERMISSION_IMPRESSION:"ins-wp-native-permission-impression",LOCAL_STORAGE:"localStorage",VARIATION_CANDIDATE:"ins-variationCandidate"},this.tableName="settings",this.hasServiceWorkerSupport="serviceWorker"in navigator,this.hasPush="PushManager"in window||"push"in navigator,this.hasNotification="Notification"in window,this.events={CORE:"nativeSdk:permission:",PROMPTED:"prompted",GRANTED:"granted",DENIED:"denied"},this.classes={optInNativeDialog:"insider-opt-in-native-dialog",optInOverlay:"insider-opt-in-overlay",optInOverlayMessage:"insider-opt-in-overlay-message",optInInstructionWrapper:"insider-opt-in-instruction-wrapper",optInInstruction:"insider-opt-in-instruction",optInInstructionClose:"insider-opt-in-instruction-close",optInInstructionImage:"insider-opt-in-instruction-image",optInInstructionMessage:"insider-opt-in-instruction-message"},this.lastSwRegistrationError="lastSwRegistrationError",this.campaignStorageNamePrefix="sp-camp-",this.METHODS={INSERT:"insert",UPDATE:"update"},this.PUSH_TYPES={WELCOME:10},this.LEAD_COLLECTION={ENDPOINT:"https://carrier.useinsider.com/v2/form/save-questionnaire/".concat(this.partnerName),REQUEST_HEADERS:{partner:this.partnerName,"Content-Type":"application/json"},REQUEST_DATA:{form_data:[],uid:Insider.getUserId(),source:window.location.href,platform:Insider.browser.getPlatform()}}}a.prototype.initialize=function(){var e=this;return this.debug=this.checkFromStorage("insider-push-debug",!0),this.initializeIndexedDB(function(t){t&&(Insider.indexedDB.save(e.tableName,{id:1,name:"partnerName",value:e.partnerName}),Insider.indexedDB.save(e.tableName,{id:2,name:"spUID",value:Insider.getUserId()}),Insider.indexedDB.save(e.tableName,{id:3,name:"lastReceivedWebPushes",value:[]}))}),this.debug&&(console.log("Initializing Native SDK"),console.log("Push Manager Support:",this.hasPush),console.log("Notification Support:",this.hasNotification)),this.hasPush&&this.hasNotification&&("Safari"!==Insider.browser.name&&this.saveImpressionLog(),this.grantPermission()),Insider.eventManager.dispatch(this.events.CORE+this.events.PROMPTED),!0},a.prototype.initializeIndexedDB=function(){var e,t=(e=i().m(function e(t){return i().w(function(e){for(;;)if(0===e.n)return Insider.indexedDB.connect("webPush",function(e){t(e)}),e.a(2,!0)},e)}),function(){var t=this,n=arguments;return new Promise(function(r,i){var s=e.apply(t,n);function a(e){o(s,r,i,a,c,"next",e)}function c(e){o(s,r,i,a,c,"throw",e)}a(void 0)})});return function(e){return t.apply(this,arguments)}}(),a.prototype.saveImpressionLog=function(){return!this.checkFromStorage(this.STORAGE.NATIVE_PERMISSION_IMPRESSION,!0)&&(this.setStorage(this.STORAGE.NATIVE_PERMISSION_IMPRESSION,!0,360),new Insider.log("w",{t:"storeLog",type:"webPush",logType:"native-permission-impression",browser:Insider.browser.name,isMobile:Insider.browser.isMobile(),language:Insider.systemRules.call("getLang")}).setLogURL(this.wpLogUrl).send(),!0)},a.prototype.grantPermission=function(){return this.appendOverlay(),this.appendInstructionMessage(),"Safari"===Insider.browser.name&&"granted"===Notification.permission?(this.registerServiceWorker(),!0):(Notification.requestPermission().then(this.handlePermissionAction.bind(this)),!0)},a.prototype.appendOverlay=function(){if(!window.insiderOptInOverlayIsActive)return!1;var e=Insider.dom().create("div",{id:this.classes.optInNativeDialog});return e.append(Insider.dom().create("div",{className:this.classes.optInOverlay})),e.append(Insider.dom().create("div",{className:this.classes.optInOverlayMessage}).text(window.insiderOptInOverlayMessage)),Insider.dom("body").append(e),Insider.eventManager.on("click",".".concat(this.classes.optInOverlay),this.removeOverlayAndInstruction.bind(this)),!0},a.prototype.appendInstructionMessage=function(){return!!window.insiderOptInInstructionMessageIsActive&&(Insider.dom("body").append(this.getInstructionMessageElement()),Insider.eventManager.on("click",".".concat(this.classes.optInInstruction),this.removeOverlayAndInstruction.bind(this)),!0)},a.prototype.getInstructionMessageElement=function(){var e=Insider.dom().create("div",{id:this.classes.optInInstructionWrapper,className:this.classes.optInInstruction});return e.append(Insider.dom().create("div",{className:this.classes.optInInstructionClose})).append(Insider.dom().create("div",{className:this.classes.optInInstructionImage}).append(Insider.dom().create("img",{src:window.insiderOptInInstructionImage}))),e.append(Insider.dom().create("div",{className:this.classes.optInInstructionMessage}).text(window.insiderOptInInstructionMessage)),e},a.prototype.handlePermissionAction=function(e){return this.removeOverlayAndInstruction(),!window.isRequestPermission&&"default"!==e&&("Safari"===Insider.browser.name&&this.saveImpressionLog(),window.isRequestPermission=!0,"granted"!==e?(Insider.eventManager.dispatch(this.events.CORE+this.events.DENIED),!1):(Insider.eventManager.dispatch(this.events.CORE+this.events.GRANTED),this.registerServiceWorker(),!0))},a.prototype.removeOverlayAndInstruction=function(){return!(!window.insiderOptInOverlayIsActive&&!window.insiderOptInInstructionMessageIsActive||(window.insiderOptInOverlayIsActive&&Insider.dom("#".concat(this.classes.optInNativeDialog)).remove(),window.insiderOptInInstructionMessageIsActive&&Insider.dom("#".concat(this.classes.optInInstructionWrapper)).remove(),0))},a.prototype.registerServiceWorker=function(){var e=this;return navigator.serviceWorker.register(this.swPath).then(this.handleRegistrationEvent.bind(this)).catch(function(t){var n="REGISTRATION_ERROR | "+"Browser: ".concat(Insider.browser.getBrowserNameForWebPushToken()," | ")+"Partner: ".concat(e.partnerName," | ")+"Error: ".concat(t.message||t.stack);e.isEqualToLastError(n)||(e.setLastSwRegistrationError(n),e.sendLogToTokenCollector(n)),e.handleException(t)}),Insider.worker.pm({type:"unregisterCustomOptInServiceWorker"}),!0},a.prototype.handleException=function(e){var t=Number(Insider.webPushState.nativeOptInCookieSettings.permissionAbandonExpireDay);return"denied"===Notification.permission&&(t=Number(Insider.webPushState.nativeOptInCookieSettings.permissionBlockExpireDay)),this.setUserPermissionGranted({pushRequestSent:!0}),this.setStorage(this.STORAGE.REQUEST_SENT,!0,t),this.debug&&console.log(e),this.removeOverlayAndInstruction(),!0},a.prototype.handleRegistrationEvent=function(e){var t=this;return e.addEventListener("updatefound",function(n){var r=n.target.installing;r.addEventListener("statechange",function(){"activated"===r.state&&t.subscribe(e)})}),this.instantSubscribe(e),!0},a.prototype.subscribe=function(e){var t={userVisibleOnly:!0};return this.isVAPIDActive&&(t.applicationServerKey=this.convertVapidKeyToInt8Array()),e.pushManager.subscribe(t).then(this.saveSubscription.bind(this)).catch(function(e){var t=this;console.log("Error occurred while subscribing existing registration: ",e),Insider.fns.has(e.message,"applicationServerKey")&&this.hasServiceWorkerSupport&&navigator.serviceWorker.getRegistration().then(function(e){Insider.fns.isUndefined(e)||e.unregister().then(function(){t.register()})})}),!0},a.prototype.saveSubscription=function(e){var t;t="subscriptionId"in e?e.subscriptionId:this.getSubscriptionId(e.endpoint);var n=Insider.fns.parse(Insider.fns.stringify(e)).keys||{},r=n.auth||"",i=n.p256dh||"";return this.setUserPermissionGranted({insdrSubsId:t,pushRequestSent:!0}),Insider.worker.pm({type:this.localStorage,message:{action:"read"},success:function(n){var s=Insider.fns.find(n,"key",this.webPushStorageKey,!0),o=Insider.fns.isEmptyArray(s)?Insider.storage.get(this.webPushStorageKey):s,a=Math.floor(Date.now()/1e3),c=this.getStorage("unificationUserDataHash")&&!this.getStorage("ins-wp-user-unification");if(this.migrationNeeded()||!Insider.fns.isEmptyArray(o)||c)c&&this.setStorage("ins-wp-user-unification","true",Insider.dateHelper.addHour()),this.saveSubscriptionId(t,r,i,this.METHODS.UPDATE),this.initializeIndexedDB(function(t){t&&(Insider.indexedDB.upsert("options",{key:"subscriptionId",value:e.endpoint}),Insider.indexedDB.upsert("options",{key:"subscriptionUpdateDate",value:a}))});else{var p=this.getWelcomeTestPushId();this.saveSubscriptionId(t,r,i,this.METHODS.INSERT,p),this.initializeIndexedDB(function(t){t&&(Insider.indexedDB.upsert("options",{key:"subscriptionId",value:e.endpoint}),Insider.indexedDB.upsert("options",{key:"subscriptionCreateDate",value:a}),Insider.indexedDB.upsert("options",{key:"subscriptionUpdateDate",value:a}))})}}.bind(this)}),!0},a.prototype.getWelcomeTestPushId=function(){var e=Insider.fns.objectValues(Insider.storage.get(this.STORAGE.VARIATION_CANDIDATE))[0];if(!e)return!1;var t=Insider.webPush.webPush.getPushById(e);return!(!t||t.otherSettings.pushType!==this.PUSH_TYPES.WELCOME)&&t.id},a.prototype.saveSubscriptionId=function(e,t,n,r){var i=this,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o={token:e,authToken:t,p256DH:n,isNativeOptIn:1,browser:Insider.browser.getBrowserNameForWebPushToken(),userId:Insider.getUserId(),pageUrl:window.location.href,language:Insider.systemRules.call("getLang"),partner:this.partnerName,method:r,swVersion:Insider.webPush.swVersion};return s&&(o.testCampaign=s),this.sendRequest({url:this.tokenCollectorUrl,data:o,headers:{partner:this.partnerName}},function(){var t=Number(Insider.webPushState.nativeOptInCookieSettings.permissionAllowExpireDay);i.setStorage(i.STORAGE.REQUEST_SENT,!0,t),i.setStorage(i.STORAGE.PAYLOAD_COMPLETE,!0,t),i.setStorage(i.STORAGE.TOKEN,e,t),i.setStorage(i.STORAGE.MIGRATED_SDK,i.swPath,t),i.setStorage(i.STORAGE.TOKEN_CREATE_DATE,Date.now(),t),r===i.METHODS.INSERT&&i.sendOptinTemplatesLeadCollectionLogs()}),!0},a.prototype.sendOptinTemplatesLeadCollectionLogs=function(){var e=this,t=(Insider.webPush.webPush.optInTemplates||{}).campaigns;return!Insider.fns.isEmptyArray(t)&&(t.forEach(function(t){var r=t.id,i=Insider.storage.localStorage.get("".concat(e.campaignStorageNamePrefix).concat(r));Insider.fns.isObject(i)&&Insider.request.post({url:e.LEAD_COLLECTION.ENDPOINT,headers:e.LEAD_COLLECTION.REQUEST_HEADERS,parse:!0,data:Insider.fns.stringify(n(n({},e.LEAD_COLLECTION.REQUEST_DATA),{},{campaign_id:r}))})}),!0)},a.prototype.setUserPermissionGranted=function(e){return Insider.fns.pm({target:window.top,type:"setUserPermissionGranted",message:e}),!0},a.prototype.getSubscriptionId=function(e){return e.split("/").pop()},a.prototype.instantSubscribe=function(e){var t;return e.installing?t=e.installing:e.waiting?t=e.waiting:e.active&&(t=e.active),!(!t||"activated"!==t.state||(this.subscribe(e),0))},a.prototype.migrationNeeded=function(){var e=this.checkFromStorage(this.STORAGE.PAYLOAD_COMPLETE,!0),t=Insider.webPushState.nativeOptInSDKCustomPath&&!this.getStorage(this.STORAGE.MIGRATED_SDK)&&e,n=!e&&this.getStorage(this.STORAGE.TOKEN);return t||n},a.prototype.getStorage=function(e){return Insider.storage.get(e,this.STORAGE.LOCAL_STORAGE,!0)},a.prototype.setStorage=function(e,t,n){return Insider.storage.set({name:e,value:t,expires:n},this.STORAGE.LOCAL_STORAGE,!0),!0},a.prototype.checkFromStorage=function(e,t){return this.getStorage(e)===t},a.prototype.convertVapidKeyToInt8Array=function(){for(var e=this.VAPIDPublicKey,t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length),i=0;i<n.length;++i)r[i]=n.charCodeAt(i);return r},a.prototype.sendRequest=function(e,t){return Insider.request.post({url:e.url,data:e.data,headers:e.headers,success:function(){(t||Insider.fns.noop)()},error:function(e,t){this.debug&&console.log(t),this.handleException(t)}.bind(this)}),!0},a.prototype.sendLogToTokenCollector=function(e){var t=Insider.storage.get(this.webPushStorageKey);return this.sendRequest({url:this.tokenCollectorUrl,headers:{"Content-Type":"application/json",partner:this.partnerName},data:Insider.fns.stringify({method:"swRegistrationError",userId:Insider.getUserId(),token:t?t.token:"-",language:t?t.language:"-",browser:Insider.browser.getBrowserNameForWebPushToken(),pageUrl:window.location.href,partner:this.partnerName,error:e,userAgent:window.navigator.userAgent})}),!0},a.prototype.isEqualToLastError=function(e){return Insider.fns.compareAsString(this.getLastSwRegistrationError(),e)},a.prototype.getLastSwRegistrationError=function(){return Insider.storage.get(this.lastSwRegistrationError)||""},a.prototype.setLastSwRegistrationError=function(e){return Insider.storage.set({name:this.lastSwRegistrationError,value:e,expires:7}),!0},(new a).initialize()}();